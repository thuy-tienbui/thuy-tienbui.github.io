{
  "hash": "778afe698bab8cdf28c33109f77b5b9a",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Assessing and forecasting Willamette Falls fish passage\"\ndescription: |\n  Investigation of time series data to understand and predict trends in fish passage\nauthor:\n  - name: Thuy-Tien Bui\ndate: 2025-03-01\ncategories: [R, Modeling]\nimage: fish_ladder.jpg\nformat:\n  html:\n    embed-resources: true\n    code-fold: true\n    toc: false\n    page-layout: full\necho: true\nmessage: false\nwarning: false\n---\n\n\n\n\n### Introduction & Data Summary\n\nFish passage is a critical component of river ecosystem health, ensuring migratory species can access spawning and rearing habitats essential for their survival. In the Pacific Northwest, species like coho salmon (Oncorhynchus kisutch), jack coho (precocious male coho that return earlier than typical adults), and steelhead trout (Oncorhynchus mykiss) rely on unobstructed passage to complete their life cycles. At Willamette Falls in Oregon, one of the largest natural waterfalls in the region, fish passage is especially important due to the historical and ongoing impacts of barriers such as dams.\n\n::::: grid\n::: g-col-6\n![~*Fish ladder at Fall Creek Dam in Oregon (Photo by Kristyna Wentz-Graff/OPB)*~](fish_ladder.jpg){fig-align=\"left\" width=\"550\" height=\"370\"}\n:::\n\n::: g-col-6\n![~*Coho salmon swimming upstream (Photo by Chuck Haney)*~](coho_upstream.png){fig-align=\"left\" width=\"600\"}\n:::\n:::::\n\nThe Willamette Falls Fish Ladder is an effort by the Oregon Department of Fish and Wildlife to support fish migration. It is composed of three individual fish ladders that merge into a single exit point above Willamette Falls. Biologists have visually counted observations of fish passing through the fishway since 2001. The dataset used in this analysis records counts for several fish species between 2001 and 2010 at the station.\n\n**Data Citation:** Columbia River DART. DART Adult Passage Counts (Willamette Falls, 2001-2010). <https://www.cbr.washington.edu/dart/query/adult_graph_text>. Accessed January 25, 2023.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(ggplot2)\nlibrary(here)\nlibrary(tsibble)\nlibrary(feasts)\nlibrary(fable)\nlibrary(paletteer)\nlibrary(janitor)\nlibrary(patchwork)\nlibrary(scales)\n```\n:::\n\n\n\n\n### Purpose & Methods\n\nThis analysis aims to assess and forecast fish passage time series data collected at the Willamette Falls fish ladder on the Willamette River in Oregon. The analysis focuses on three select focal species: Coho salmon, Jack coho salmon, and Steelhead trout. The following procedure outlines the methods of this analysis:\n\n1.  Convert data frame into a time series data frame.\n\n2.  Plot the time series to assess general temporal trends in fish passage for each species.\n\n3.  Create a seasonplot to assess fish passage trends throughout years across the study period for each species.\n\n4.  Aggregate fish counts by year and plot annual fish counts for each species to understand annual fish passage trends.\n\n5.  Forecast salmon runs using Holt-Winters exponential smoothing.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load data, replace NA with 0, and convert to tsibble\nfish_ts <- read_csv(here(\"data\", \"willamette_fish_passage.csv\")) %>% \n  clean_names() %>% \n  mutate_all(~replace(., is.na(.), 0)) %>% \n  select(date, coho, jack_coho, steelhead) %>% \n  mutate(date = lubridate::mdy(date)) %>%\n  as_tsibble(key = NULL, \n             index = date)\n  \n\n# Pivot data longer\nfish_long <- fish_ts %>% \n  pivot_longer(-date, \n               names_to = \"species\", \n               values_to = \"count\")\n```\n:::\n\n\n\n\n### Results\n\n::: panel-tabset\n#### Time Series\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plot time series and facet wrap by species\nfish_long %>% \n  ggplot(aes(x = date, y = count, color = species)) +\n  geom_line() +\n  scale_color_manual(values = c('#BA7999FF', '#59629BFF', '#015B58FF')) +\n  facet_wrap(~species, \n             nrow = 3, \n             labeller = labeller(species = \n                                   c(\"coho\" = \"Coho\",\n                                     \"jack_coho\" = \"Jack Coho\",\n                                     \"steelhead\" = \"Steelhead\")),\n             scales = \"free_y\") +\n  labs(title = \"Adult Fish Passage at Willamette Falls 2001-2010\",\n       x = \"Date\",\n       y = \"Count of Fish\") +\n  scale_y_continuous(labels = scales::comma) +\n  theme_minimal() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![Figure 1. Fish Passage Counts Time Series. Counts of fish passing through the Willamette Falls fish ladder from 2001-2010 by species.](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n\n\n> -   All three fish species pass through Willamette Falls at relatively regular intervals annually.\n>\n> -   Peak Coho and Jack coho passage align at the same time, within fairly narrow windows.\n>\n> -   Steelhead passage occurs over a wider time window, with variable, less-defined peaks compared to the sharp peaks observed in Coho and Jack Coho counts.\n\n#### Seasonplot\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Season plot\nfish_long %>%\n  gg_season(y = count, pal = paletteer_d(\"PNWColors::Starfish\")) +\n  facet_wrap(~species, \n             nrow = 3, \n             labeller = labeller(species = \n                                   c(\"coho\" = \"Coho\",\n                                     \"jack_coho\" = \"Jack Coho\",\n                                     \"steelhead\" = \"Steelhead\")),\n             scales = \"free_y\") +\n  labs(x = \"Date\",\n       y = \"Count of Fish\",\n       title=\"Seasonal Trends in Adult Fish Passage at Willamette Falls\") +\n  scale_y_continuous(labels = scales::comma) +\n    theme_minimal()\n```\n\n::: {.cell-output-display}\n![Figure 2. Fish Passage Counts Seasonplot. Counts of fish passage by species throughout the year from 2001-2010. Counts in earlier years are green and blue and more recent years are in purple and pink.](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n\n> -   Peak passage times for Coho and Jack Coho occur annually during the fall. There are lower and narrower peaks in earlier years compared to more recent years.\n>\n> -   Steelhead passage follows a different seasonal pattern, with variable peaks from winter through mid-summer, with counts leveling off during the late summer and fall. Higher passage counts occurred during earlier years, with more recent years observing less steelhead at Willamette Falls.\n\n#### Annual Counts\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Group data by fish species and year\nfish_ts_year <- fish_long %>% \n  index_by(year = ~year(.)) %>% \n  group_by(species, year) %>%\n  summarise(annual_count = sum(count))\n\n# Plot annual fish passage by species\nfish_ts_year %>% \n  ggplot(aes(x = year, y = annual_count, color = species)) +\n  geom_line() +\n  geom_point() +\n  scale_color_manual(values = c('#BA7999FF', '#59629BFF', '#015B58FF')) +\n  facet_wrap(~species, \n             nrow = 3, \n             labeller = labeller(species = \n                                   c(\"coho\" = \"Coho\",\n                                     \"jack_coho\" = \"Jack Coho\",\n                                     \"steelhead\" = \"Steelhead\")),\n             scales = \"free_y\") +\n  labs(title = \"Annual Counts of Adult Fish Passage at Willamette Falls 2001-2010\",\n       x = \"Year\",\n       y = \"Count of Fish\") +\n  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +\n  scale_y_continuous(labels = scales::comma) +\n  theme_minimal() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![Figure 3. Annual Fish Counts 2001-2010. Counts of fish passage by species and year.](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\n> -   Coho numbers fluctuate over the years with a notable significant increase between 2008 and 2009.\n>\n> -   Jack coho numbers also fluctuate, with a declining trend from 2002-2005. Jack Coho numbers saw a significant increase between 2007 and 2008 before the observed increase in Coho the following year. However, it is unclear from the data alone whether Coho and Jack coho species influence one another's population dynamics.\n>\n> -   Steelhead numbers show a general decline throughout the study period. However, counts of steelhead increase in 2009, which may be an indicator of population recovery efforts for the endangered species. Still, continued monitoring over time is necessary to draw meaningful conclusions.\n\n#### Forecast\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get data into year and month form\nfish_month <- fish_long %>% \n  index_by(yr_mo = ~yearmonth(.)) %>%  \n  group_by(species, yr_mo) %>% \n  summarize(count = round(sum(count, na.rm = TRUE)))  %>%  \n  ungroup()\n\n# Create forecast model for each species\nsteelhead_fit <- fish_month %>%\n  filter(species == 'steelhead') %>%\n  model(\n    ets = ETS(count ~  trend(method = \"A\") + season(method = \"A\"))\n  )\n\ncoho_fit <- fish_month %>%\n  filter(species == 'coho') %>%\n  model(\n    ets = ETS(count ~  trend(method = \"A\") + season(method = \"A\"))\n  )\n  \njack_fit <- fish_month %>%\n  filter(species == 'jack_coho') %>%\n  model(\n    ets = ETS(count ~  trend(method = \"A\") + season(method = \"A\"))\n  )\n\n# Forecast using the model 5 years into the future:\nsteelhead_forecast <- steelhead_fit %>% \n  forecast(h = \"5 years\", level = c(80, 95)) %>% \n  hilo(level = c(80, 95)) %>% \n mutate(\n    lower_80 = str_split(`80%`, \",\") %>%\n      sapply(function(x) as.numeric(str_trim(str_replace(x[1], \"\\\\[|\\\\]\", \"\")))), \n    upper_80 = str_split(`80%`, \",\") %>%\n      sapply(function(x) as.numeric(str_trim(str_replace(x[2], \"\\\\]\", \"\")))),\n    lower_95 = str_split(`95%`, \",\") %>%\n      sapply(function(x) as.numeric(str_trim(str_replace(x[1], \"\\\\[|\\\\]\", \"\")))), \n    upper_95 = str_split(`95%`, \",\") %>%\n      sapply(function(x) as.numeric(str_trim(str_replace(x[2], \"\\\\]\", \"\")))),\n  ) %>% \n  clean_names() %>% \n  select(-x80_percent, -x95_percent) %>% \n  rename(\n    count = mean,\n    old_count = count    \n  ) %>%\n  mutate(count = round(count, 0))\n\ncoho_forecast <- coho_fit %>% \n  forecast(h = \"5 years\", level = c(80, 95)) %>% \n  hilo(level = c(80, 95)) %>% \n  mutate(\n    lower_80 = str_split(`80%`, \",\") %>%\n      sapply(function(x) as.numeric(str_trim(str_replace(x[1], \"\\\\[|\\\\]\", \"\")))), \n    upper_80 = str_split(`80%`, \",\") %>%\n      sapply(function(x) as.numeric(str_trim(str_replace(x[2], \"\\\\]\", \"\")))),\n    lower_95 = str_split(`95%`, \",\") %>%\n      sapply(function(x) as.numeric(str_trim(str_replace(x[1], \"\\\\[|\\\\]\", \"\")))), \n    upper_95 = str_split(`95%`, \",\") %>%\n      sapply(function(x) as.numeric(str_trim(str_replace(x[2], \"\\\\]\", \"\")))),\n  ) %>% \n  clean_names() %>% \n  select(-x80_percent, -x95_percent) %>% \n  rename(\n    count = mean,\n    old_count = count    \n  ) %>%\n  mutate(count = round(count, 0))\n\njack_forecast <- jack_fit %>% \n  forecast(h = \"5 years\", level = c(80, 95)) %>% \n  hilo(level = c(80, 95)) %>% \n  mutate(\n    lower_80 = str_split(`80%`, \",\") %>%\n      sapply(function(x) as.numeric(str_trim(str_replace(x[1], \"\\\\[|\\\\]\", \"\")))), \n    upper_80 = str_split(`80%`, \",\") %>%\n      sapply(function(x) as.numeric(str_trim(str_replace(x[2], \"\\\\]\", \"\")))),\n    lower_95 = str_split(`95%`, \",\") %>%\n      sapply(function(x) as.numeric(str_trim(str_replace(x[1], \"\\\\[|\\\\]\", \"\")))), \n    upper_95 = str_split(`95%`, \",\") %>%\n      sapply(function(x) as.numeric(str_trim(str_replace(x[2], \"\\\\]\", \"\")))),\n  ) %>% \n  clean_names() %>% \n  select(-x80_percent, -x95_percent) %>% \n  rename(\n    count = mean,\n    old_count = count    \n  ) %>%\n  mutate(count = round(count, 0))\n\n# Combine dataframes for plotting\nsteelhead_forecast_df <- bind_rows(\n  fish_month %>% mutate(source = \"Observed\"),\n  steelhead_forecast %>% mutate(source = \"Forecasted\")\n)\n\ncoho_forecast_df <- bind_rows(\n  fish_month %>% mutate(source = \"Observed\"),\n  coho_forecast %>% mutate(source = \"Forecasted\")\n)\n\njack_forecast_df <- bind_rows(\n  fish_month %>% mutate(source = \"Observed\"),\n  jack_forecast %>% mutate(source = \"Forecasted\")\n)\n\n# Plot for coho\np1 <- ggplot(coho_forecast_df, aes(x = yr_mo, y = count, color = source)) +\n  geom_ribbon(aes(ymin = lower_95, ymax = upper_95, fill = \"95% CI\"), \n              alpha = 1, color = NA) +  \n  geom_ribbon(aes(ymin = lower_80, ymax = upper_80, fill = \"80% CI\"), \n              alpha = 1, color = NA) +\n  geom_line() + \n  labs(title = \"Coho\") +\n  scale_color_manual(values = c(\"Observed\" = \"black\", \"Forecasted\" = \"#BA7999FF\")) +\n  scale_fill_manual(values = c(\"80% CI\" = \"#d2a4ba\", \"95% CI\" = \"#e9d1dc\")) +\n  theme_minimal() +\n  theme(legend.title = element_blank(),\n    axis.title.x = element_blank(), \n    axis.title.y = element_blank() )\n\n# Plot for jack coho\np2 <- ggplot(jack_forecast_df, aes(x = yr_mo, y = count, color = source)) +\n  geom_ribbon(aes(ymin = lower_95, ymax = upper_95, fill = \"95% CI\"), \n              alpha = 1, color = NA) +  \n  geom_ribbon(aes(ymin = lower_80, ymax = upper_80, fill = \"80% CI\"), \n              alpha = 1, color = NA) +\n  geom_line() + \n  labs(title = \"Jack Coho\", y = \"Count\") +\n  scale_color_manual(values = c(\"Observed\" = \"black\", \"Forecasted\" = \"#59629BFF\")) +\n  scale_fill_manual(values = c(\"80% CI\" = \"#8c94bd\", \"95% CI\" = \"#c4c9de\")) +\n  theme_minimal() +\n  theme(legend.title = element_blank(),\n        axis.title.x = element_blank(),)\n\n# Plot for steelhead\np3 <- ggplot(steelhead_forecast_df, aes(x = yr_mo, y = count, color = source)) +\n  geom_ribbon(aes(ymin = lower_95, ymax = upper_95, fill = \"95% CI\"), \n              alpha = 1, color = NA) +  \n  geom_ribbon(aes(ymin = lower_80, ymax = upper_80, fill = \"80% CI\"), \n              alpha = 1, color = NA) +\n  geom_line() + \n  labs(title = \"Steelhead\", x = \"Date\") +\n  scale_color_manual(values = c(\"Observed\" = \"black\", \"Forecasted\" = \"#015B58FF\")) +\n  scale_fill_manual(values = c(\"80% CI\" = \"#7ca19e\", \"95% CI\" = \"#afc6c4\")) +\n  theme_minimal() +\n  theme(legend.title = element_blank(),\n        axis.title.y = element_blank(),)\n\n# Combine the plots vertically and set the layout\nforecast_plot <- p1 / p2 / p3 + \n  plot_layout(guides = \"collect\") +\n  plot_annotation(title = \"Five-year fish count forecast\")\n\n# Print the combined plot\nprint(forecast_plot)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n\n> -   The forecast model predicts similar overall patterns over the next 5 years in this data time frame. However, the magnitude and granularity of the predicted counts is simplified.\n>\n> -   In the case of Jack Coho, forecasted fish counts did not resemble observed trends, with predicted counts significantly decreasing over the next 5 years.\n>\n> -   Given these results, a Holt-Winters forecast method is not very useful in predicting fish counts. This is due to variable trends within the data and inability of the model to account for complex ecological dynamics that influence fish count.\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}